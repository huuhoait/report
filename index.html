        <!DOCTYPE html>
        <html lang="vi">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Mobile Banking BI Dashboard (Vietnam)</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
            
            <!-- Chosen Palette: Enterprise Indigo & Neutral Grays -->
            <!-- Application Structure Plan: Chuy·ªÉn ƒë·ªïi ho√†n to√†n sang b·ªë c·ª•c b√°o c√°o trang ƒë∆°n (single-page report) theo phong c√°ch Power BI ƒë∆∞·ª£c y√™u c·∫ßu. Lo·∫°i b·ªè sidebar v√† tabs. To√†n b·ªô n·ªôi dung ƒë∆∞·ª£c ƒë·∫∑t tr√™n m·ªôt trang, c√≥ th·ªÉ cu·ªôn. C·∫•u tr√∫c bao g·ªìm: 1. Header (Ti√™u ƒë·ªÅ + L·ªçc ng√†y). 2. L∆∞·ªõi KPI ch√≠nh. 3. L∆∞·ªõi KPI Giao d·ªãch. 4. L∆∞·ªõi Bi·ªÉu ƒë·ªì chi ti·∫øt (t·∫•t c·∫£ bi·ªÉu ƒë·ªì). C·∫•u tr√∫c n√†y tr·ª±c ti·∫øp m√¥ ph·ªèng h√¨nh ·∫£nh dashboard ƒë∆∞·ª£c cung c·∫•p, ∆∞u ti√™n m·∫≠t ƒë·ªô th√¥ng tin v√† giao di·ªán "b√°o c√°o" chuy√™n nghi·ªáp. -->
            <!-- Visualization & Content Choices: T·∫•t c·∫£ KPI v√† Bi·ªÉu ƒë·ªì ƒë∆∞·ª£c ƒë√≥ng g√≥i trong 'report-card' m·ªõi. M·ªói th·∫ª c√≥ '.report-card-title' (thanh ti√™u ƒë·ªÅ x√°m) v√† '.report-card-body' (n·ªôi dung) ƒë·ªÉ kh·ªõp v·ªõi phong c√°ch y√™u c·∫ßu. KPI ƒë∆∞·ª£c thi·∫øt k·∫ø l·∫°i ƒë·ªÉ hi·ªÉn th·ªã s·ªë l·ªõn, n·ªïi b·∫≠t, v√† th√™m so s√°nh v·ªõi k·ª≥ tr∆∞·ªõc. Bi·ªÉu ƒë·ªì (Canvas) n·∫±m b√™n trong ph·∫ßn body c·ªßa th·∫ª. -->
            <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
            
            <style>
                body {
                    font-family: 'Inter', sans-serif;
                    background-color: #f3f4f6;
                }
                .report-card {
                    @apply shadow-lg rounded-xl overflow-hidden border-2 border-indigo-100 hover:border-indigo-300 hover:shadow-xl transition-all duration-300;
                    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                    position: relative;
                }
                .report-card-title {
                    @apply bg-gray-700 text-white text-sm font-semibold py-2 px-4;
                }
                .report-card-body {
                    @apply p-4;
                }
                .kpi-value-main {
                    @apply text-4xl lg:text-5xl font-bold text-gray-900;
                }
                .kpi-change {
                    @apply text-sm font-medium;
                }

                .chart-container {
                    position: relative;
                    width: 100%;
                    max-width: 600px;
                    margin-left: auto;
                    margin-right: auto;
                    height: 300px;
                    max-height: 400px;
                }
                @media (min-width: 768px) {
                    .chart-container {
                        height: 350px;
                    }
                }
                .chart-container-tall {
                    position: relative;
                    width: 100%;
                    max-width: 900px;
                    margin-left: auto;
                    margin-right: auto;
                    height: 350px;
                    max-height: 450px;
                }
                
                .modal-overlay {
                    @apply fixed inset-0 bg-black bg-opacity-50 z-40 hidden justify-center items-center;
                }
                .modal-content {
                    @apply bg-white rounded-lg shadow-xl w-11/12 max-w-lg p-6 relative z-50;
                }
                .modal-header {
                    @apply flex justify-between items-center pb-3 border-b;
                }
                .modal-close {
                    @apply text-gray-500 hover:text-gray-800 text-3xl font-light;
                }
                .modal-body {
                    @apply my-4;
                }
                .loader {
                    @apply w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin;
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
                .gemini-button {
                    @apply bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl text-sm font-semibold hover:from-purple-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl border-2 border-purple-400 hover:border-purple-300;
                    background-size: 200% 200%;
                    animation: gradientShift 3s ease infinite;
                }
                
                @keyframes gradientShift {
                    0% { background-position: 0% 50%; }
                    50% { background-position: 100% 50%; }
                    100% { background-position: 0% 50%; }
                }
                
                /* Tab Styles */
                .tab-button {
                    padding: 0.75rem 1.5rem;
                    font-size: 0.875rem;
                    font-weight: 500;
                    border-radius: 0.5rem;
                    transition: all 0.2s;
                    cursor: pointer;
                    border: none;
                    outline: none;
                }
                .tab-button.active {
                    background-color: #4f46e5;
                    color: white;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                }
                .tab-button.inactive {
                    background-color: white;
                    color: #6b7280;
                    border: 1px solid #d1d5db;
                }
                .tab-button.inactive:hover {
                    background-color: #f9fafb;
                }
                .tab-content {
                    display: none;
                }
                .tab-content.active {
                    display: block;
                }
            </style>
        </head>
        <body class="text-gray-800">

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col">
                
                <!-- Main Content -->
                <main class="container mx-auto p-4 sm:p-6 lg:p-8">
                    
                    <!-- Page Header -->
                    <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">BI Dashboard: Mobile Banking</h1>
                            <p class="text-gray-600">B√°o c√°o hi·ªáu su·∫•t to√†n di·ªán</p>
                        </div>
                        <div class="mt-4 sm:mt-0">
                            <label for="date-filter" class="sr-only">L·ªçc theo ng√†y</label>
                            <select id="date-filter" class="w-full sm:w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                                <option value="30">30 ng√†y qua</option>
                                <option value="7">7 ng√†y qua</option>
                                <option value="90">90 ng√†y qua</option>
                                <option value="all">To√†n th·ªùi gian</option>
                            </select>
                        </div>
                    </header>

                    <!-- Tab Navigation -->
                    <div class="mb-8 border-b border-gray-200">
                        <nav class="flex space-x-8" aria-label="Tabs">
                            <button id="tab-overview" class="tab-button active" onclick="switchTab('overview')">
                                üìä T·ªïng quan
                            </button>
                            <button id="tab-onboarding" class="tab-button inactive" onclick="switchTab('onboarding')">
                                üë• Onboarding
                            </button>
                            <button id="tab-transaction" class="tab-button inactive" onclick="switchTab('transaction')">
                                üí≥ Giao d·ªãch
                            </button>
                            <button id="tab-engagement" class="tab-button inactive" onclick="switchTab('engagement')">
                                üéØ T∆∞∆°ng t√°c
                            </button>
                        </nav>
                    </div>

                    <!-- Tab Content: Overview -->
                    <div id="content-overview" class="tab-content active">
                        <!-- Section: Overview KPIs -->
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">T·ªïng quan KPI</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                            <div class="report-card">
                                <div class="report-card-title">Ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông (MAU)</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-mau-current">1.25M</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-mau-change">+5.2%</span>
                                        <span class="text-sm text-gray-500" id="kpi-mau-previous">vs 1.19M</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">Ng∆∞·ªùi d√πng m·ªõi</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-newUsers-current">45,208</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-newUsers-change">+8.1%</span>
                                        <span class="text-sm text-gray-500" id="kpi-newUsers-previous">vs 41,820</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">T·ªïng SL Giao d·ªãch</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-totalTx-current">22.4M</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-totalTx-change">+12.5%</span>
                                        <span class="text-sm text-gray-500" id="kpi-totalTx-previous">vs 19.9M</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">T·ª∑ l·ªá GD th√†nh c√¥ng</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-successRate-current">99.1%</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-red-600" id="kpi-successRate-change">-0.2%</span>
                                        <span class="text-sm text-gray-500" id="kpi-successRate-previous">vs 99.3%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Overview Charts -->
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ph√¢n t√≠ch Chi ti·∫øt</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- DAU Chart -->
                            <div class="report-card">
                                <div class="report-card-title">Ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông (DAU)</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="dauChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TX Volume Chart -->
                            <div class="report-card">
                                <div class="report-card-title">Kh·ªëi l∆∞·ª£ng Giao d·ªãch</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="txVolumeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Onboarding -->
                    <div id="content-onboarding" class="tab-content">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Onboarding & Acquisition</h2>
                        
                        <!-- Onboarding KPIs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-8">
                            <div class="report-card">
                                <div class="report-card-title">Ng∆∞·ªùi d√πng m·ªõi</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-onb-newUsers-current">45,208</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-onb-newUsers-change">+8.1%</span>
                                        <span class="text-sm text-gray-500" id="kpi-onb-newUsers-previous">vs 41,820</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">T·ª∑ l·ªá ho√†n th√†nh eKYC</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-onb-conversion-current">67.9%</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-onb-conversion-change">+2.1%</span>
                                        <span class="text-sm text-gray-500" id="kpi-onb-conversion-previous">vs 65.8%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Onboarding Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Onboarding Funnel -->
                            <div class="report-card">
                                <div class="report-card-title">Ph·ªÖu Onboarding</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="onboardingFunnelChart"></canvas>
                                    </div>
                                    <div class="mt-4 text-center">
                                        <button id="analyze-onboarding" class="gemini-button">‚ú® Ph√¢n t√≠ch ƒëi·ªÉm r∆°i eKYC</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Acquisition Channels -->
                            <div class="report-card">
                                <div class="report-card-title">K√™nh Onboard</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="acquisitionChannelChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Onboarding by Region -->
                            <div class="report-card">
                                <div class="report-card-title">Onboarding theo Khu v·ª±c</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="onboardingByRegionChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Onboarding by Marketing Campaign -->
                            <div class="report-card">
                                <div class="report-card-title">Onboarding theo Campaign Marketing</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="onboardingByCampaignChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Transaction -->
                    <div id="content-transaction" class="tab-content">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Hi·ªáu su·∫•t Giao d·ªãch</h2>
                        
                        <!-- Transaction KPIs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
                            <div class="report-card">
                                <div class="report-card-title">T·ª∑ l·ªá GD T.C√¥ng</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-tx-txSuccess-current">99.1%</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-red-600" id="kpi-tx-txSuccess-change">-0.2%</span>
                                        <span class="text-sm text-gray-500" id="kpi-tx-txSuccess-previous">vs 99.3%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">T·ª∑ l·ªá < 3s (Real-time)</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-tx-txRealtime-current">98.5%</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-tx-txRealtime-change">+0.1%</span>
                                        <span class="text-sm text-gray-500" id="kpi-tx-txRealtime-previous">vs 98.4%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">T·ª∑ l·ªá GD Th·∫•t b·∫°i</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-tx-txFail-current">0.9%</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-red-600" id="kpi-tx-txFail-change">+0.2%</span>
                                        <span class="text-sm text-gray-500" id="kpi-tx-txFail-previous">vs 0.7%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">L·ªói Core Bank (Top)</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-tx-txCoreError-current">0.4%</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-red-600" id="kpi-tx-txCoreError-change">+0.05%</span>
                                        <span class="text-sm text-gray-500" id="kpi-tx-txCoreError-previous">vs 0.35%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">SL KH m·ªõi c√≥ GD</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-tx-newTxCustomers-current">18,450</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-tx-newTxCustomers-change">+15.2%</span>
                                        <span class="text-sm text-gray-500" id="kpi-tx-newTxCustomers-previous">vs 16,010</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Transaction Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- TX Success/Fail -->
                            <div class="report-card">
                                <div class="report-card-title">T·ª∑ l·ªá Giao d·ªãch T.c√¥ng/Th·∫•t b·∫°i</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="txSuccessFailChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- TX Fail Reason -->
                            <div class="report-card">
                                <div class="report-card-title">L√Ω do Giao d·ªãch Th·∫•t b·∫°i (Top 5)</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="txFailReasonChart"></canvas>
                                    </div>
                                    <div class="mt-4 text-center">
                                        <button id="analyze-failures" class="gemini-button">‚ú® ƒê·ªÅ xu·∫•t gi·∫£i ph√°p l·ªói GD</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Top TX Type -->
                            <div class="report-card">
                                <div class="report-card-title">Lo·∫°i Giao d·ªãch Ph·ªï bi·∫øn (theo SLGD)</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="topTxTypeChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- TX by Region -->
                            <div class="report-card">
                                <div class="report-card-title">SL Giao d·ªãch theo Khu v·ª±c</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="txByRegionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Engagement -->
                    <div id="content-engagement" class="tab-content">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">T∆∞∆°ng t√°c & Engagement</h2>
                        
                        <!-- Engagement KPIs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
                            <div class="report-card">
                                <div class="report-card-title">Login rate</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main text-red-600" id="kpi-eng-churn-current">4.2%</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-eng-churn-change">-0.5%</span>
                                        <span class="text-sm text-gray-500" id="kpi-eng-churn-previous">vs 4.7%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">Average Session Length</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-eng-session-current">3.5 ph√∫t</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-eng-session-change">+12s</span>
                                        <span class="text-sm text-gray-500" id="kpi-eng-session-previous">vs 3.3 ph√∫t</span>
                                    </div>
                                </div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-title">T·ªïng KH Login</div>
                                <div class="report-card-body">
                                    <div class="kpi-value-main" id="kpi-eng-totalLogin-current">892,450</div>
                                    <div class="flex justify-between items-baseline mt-1">
                                        <span class="kpi-change text-green-600" id="kpi-eng-totalLogin-change">+8.3%</span>
                                        <span class="text-sm text-gray-500" id="kpi-eng-totalLogin-previous">vs 824,120</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Engagement Charts -->
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Stickiness -->
                            <div class="report-card">
                                <div class="report-card-title">T·ª∑ l·ªá DAU / MAU (Stickiness)</div>
                                <div class="report-card-body">
                                    <div class="chart-container-tall">
                                        <canvas id="stickinessChart"></canvas>
                                    </div>
                                    <div class="mt-4 text-center">
                                        <button id="analyze-engagement" class="gemini-button">‚ú® G·ª£i √Ω c·∫£i thi·ªán t∆∞∆°ng t√°c</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- Gemini Modal -->
            <div id="gemini-modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-title" class="text-lg font-semibold text-gray-800"></h3>
                        <button id="modal-close" class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body" id="modal-body-content">
                        <div class="flex justify-center items-center h-32" id="modal-loader">
                            <div class="loader"></div>
                        </div>
                        <div id="modal-result" class="text-gray-700" style="white-space: pre-wrap;"></div>
                    </div>
                </div>
            </div>

                    <!-- Tab Content: Transaction -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    
                    Chart.register(ChartDataLabels);
                    
                    Chart.defaults.font.family = "'Inter', sans-serif";
                    Chart.defaults.font.weight = 500;

                    const chartData = {
                        '30': {
                            kpi: {
                                mau: { current: '1.25M', previous: '1.19M', change: '+5.2%', changeColor: 'text-green-600' },
                                newUsers: { current: '45,208', previous: '41,820', change: '+8.1%', changeColor: 'text-green-600' },
                                totalTx: { current: '22.4M', previous: '19.9M', change: '+12.5%', changeColor: 'text-green-600' },
                                successRate: { current: '99.1%', previous: '99.3%', change: '-0.2%', changeColor: 'text-red-600' },
                                txSuccess: { current: '99.1%', previous: '99.3%', change: '-0.2%', changeColor: 'text-red-600' },
                                txRealtime: { current: '98.5%', previous: '98.4%', change: '+0.1%', changeColor: 'text-green-600' },
                                txFail: { current: '0.9%', previous: '0.7%', change: '+0.2%', changeColor: 'text-red-600' },
                                txCoreError: { current: '0.4%', previous: '0.35%', change: '+0.05%', changeColor: 'text-red-600' },
                                newTxCustomers: { current: '18,450', previous: '16,010', change: '+15.2%', changeColor: 'text-green-600' },
                                churn: { current: '4.2%', previous: '4.7%', change: '-0.5%', changeColor: 'text-green-600' },
                                session: { current: '3.5 ph√∫t', previous: '3.3 ph√∫t', change: '+12s', changeColor: 'text-green-600' },
                                totalLogin: { current: '892,450', previous: '824,120', change: '+8.3%', changeColor: 'text-green-600' }
                            },
                            dau: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12', 'T13', 'T14', 'T15', 'T16', 'T17', 'T18', 'T19', 'T20', 'T21', 'T22', 'T23', 'T24', 'T25', 'T26', 'T27', 'T28', 'T29', 'T30'], data: [320, 340, 330, 350, 360, 370, 380, 375, 385, 390, 400, 410, 405, 415, 420, 425, 430, 420, 435, 440, 450, 445, 455, 460, 470, 465, 475, 480, 490, 500], previousData: [290, 310, 300, 320, 330, 340, 350, 345, 355, 360, 370, 380, 375, 385, 390, 395, 400, 390, 405, 410, 420, 415, 425, 430, 440, 435, 445, 450, 460, 470] },
                            txVolume: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12', 'T13', 'T14', 'T15', 'T16', 'T17', 'T18', 'T19', 'T20', 'T21', 'T22', 'T23', 'T24', 'T25', 'T26', 'T27', 'T28', 'T29', 'T30'], data: [0.8, 0.9, 0.85, 0.95, 1.0, 1.1, 1.05, 1.15, 1.2, 1.25, 1.3, 1.35, 1.4, 1.45, 1.5, 1.55, 1.6, 1.65, 1.7, 1.75, 1.8, 1.85, 1.9, 1.95, 2.0, 2.05, 2.1, 2.15, 2.2, 2.3], previousData: [0.7, 0.8, 0.75, 0.85, 0.9, 1.0, 0.95, 1.05, 1.1, 1.15, 1.2, 1.25, 1.3, 1.35, 1.4, 1.45, 1.5, 1.55, 1.6, 1.65, 1.7, 1.75, 1.8, 1.85, 1.9, 1.95, 2.0, 2.05, 2.1, 2.2] },
                            onboarding: { labels: ['Truy c·∫≠p App', 'B·∫Øt ƒë·∫ßu ƒêK', 'X√°c th·ª±c OTP', 'eKYC', 'Ho√†n th√†nh'], data: [20000, 15000, 14000, 10000, 9500], previousData: [19000, 14000, 13000, 9000, 8500] },
                            acquisition: { labels: ['eskyone', 'S3', 'Partner', 'Counter'], data: [40, 30, 15, 15], previousData: [42, 28, 18, 12] },
                            onboardingByRegion: { labels: ['H·ªì Ch√≠ Minh', 'H√† N·ªôi', 'ƒê√† N·∫µng', 'C·∫ßn Th∆°', 'Kh√°c'], data: [8500, 6200, 3100, 2800, 1600], previousData: [7800, 5900, 2900, 2500, 1400] },
                            onboardingByCampaign: { labels: ['Summer Sale', 'New User Bonus', 'Referral Program', 'Holiday Promo', 'Kh√°c'], data: [4200, 3800, 2900, 2100, 1800], previousData: [3900, 3500, 2700, 1900, 1600] },
                            txSuccessFail: { labels: ['Th√†nh c√¥ng', 'Th·∫•t b·∫°i'], data: [99.1, 0.9], previousData: [99.3, 0.7] },
                            txFailReason: { labels: ['L·ªói Core Bank', 'Timeout h·ªá th·ªëng', 'Sai th√¥ng tin', 'L·ªói k·∫øt n·ªëi', 'H·∫øt h·∫°n GD'], data: [45, 25, 15, 10, 5], previousData: [42, 28, 15, 10, 5] },
                            topTxType: { labels: ['Chuy·ªÉn kho·∫£n', 'Thanh to√°n Hƒê', 'N·∫°p ti·ªÅn ƒêT', 'Qu√©t QR', 'Ti·∫øt ki·ªám'], data: [10.2, 5.1, 3.5, 2.0, 1.6], previousData: [9.8, 4.9, 3.2, 1.8, 1.5] },
                            txByRegion: { labels: ['H·ªì Ch√≠ Minh', 'H√† N·ªôi', 'ƒê√† N·∫µng', 'C·∫ßn Th∆°', 'Kh√°c'], data: [8.5, 6.2, 3.1, 2.8, 1.6], previousData: [7.8, 5.9, 2.9, 2.5, 1.4] },
                            stickiness: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'], data: [18, 19, 20, 19, 21, 22, 23, 22, 24, 25, 24, 26], previousData: [17, 18, 19, 18, 20, 21, 22, 21, 23, 24, 23, 25] }
                        },
                        '7': {
                            kpi: {
                                mau: { current: '1.21M', previous: '1.20M', change: '+1.1%', changeColor: 'text-green-600' },
                                newUsers: { current: '9,800', previous: '10,050', change: '-2.5%', changeColor: 'text-red-600' },
                                totalTx: { current: '4.8M', previous: '4.66M', change: '+3.0%', changeColor: 'text-green-600' },
                                successRate: { current: '99.0%', previous: '99.3%', change: '-0.3%', changeColor: 'text-red-600' },
                                txSuccess: { current: '99.0%', previous: '99.3%', change: '-0.3%', changeColor: 'text-red-600' },
                                txRealtime: { current: '98.2%', previous: '98.3%', change: '-0.1%', changeColor: 'text-red-600' },
                                txFail: { current: '1.0%', previous: '0.7%', change: '+0.3%', changeColor: 'text-red-600' },
                                txCoreError: { current: '0.5%', previous: '0.4%', change: '+0.1%', changeColor: 'text-red-600' },
                                newTxCustomers: { current: '4,120', previous: '4,250', change: '-3.1%', changeColor: 'text-red-600' },
                                churn: { current: '4.0%', previous: '4.1%', change: '-0.1%', changeColor: 'text-green-600' },
                                session: { current: '3.4 ph√∫t', previous: '3.5 ph√∫t', change: '-5s', changeColor: 'text-red-600' },
                                totalLogin: { current: '198,650', previous: '201,200', change: '-1.3%', changeColor: 'text-red-600' }
                            },
                            dau: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'], data: [470, 465, 475, 480, 490, 500, 495], previousData: [450, 445, 455, 460, 470, 480, 475] },
                            txVolume: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'], data: [2.0, 2.05, 2.1, 2.15, 2.2, 2.3, 2.25], previousData: [1.9, 1.95, 2.0, 2.05, 2.1, 2.2, 2.15] },
                            onboarding: { labels: ['Truy c·∫≠p App', 'B·∫Øt ƒë·∫ßu ƒêK', 'X√°c th·ª±c OTP', 'eKYC', 'Ho√†n th√†nh'], data: [4500, 3200, 3000, 2100, 2000], previousData: [4300, 3000, 2800, 1900, 1800] },
                            acquisition: { labels: ['eskyone', 'S3', 'Partner', 'Counter'], data: [38, 35, 12, 15], previousData: [40, 33, 12, 15] },
                            onboardingByRegion: { labels: ['H·ªì Ch√≠ Minh', 'H√† N·ªôi', 'ƒê√† N·∫µng', 'C·∫ßn Th∆°', 'Kh√°c'], data: [1900, 1380, 690, 620, 350], previousData: [1750, 1320, 660, 590, 330] },
                            onboardingByCampaign: { labels: ['Summer Sale', 'New User Bonus', 'Referral Program', 'Holiday Promo', 'Kh√°c'], data: [920, 830, 630, 460, 390], previousData: [850, 770, 590, 420, 360] },
                            txSuccessFail: { labels: ['Th√†nh c√¥ng', 'Th·∫•t b·∫°i'], data: [99.0, 1.0], previousData: [99.3, 0.7] },
                            txFailReason: { labels: ['L·ªói Core Bank', 'Timeout h·ªá th·ªëng', 'Sai th√¥ng tin', 'L·ªói k·∫øt n·ªëi', 'H·∫øt h·∫°n GD'], data: [50, 22, 15, 8, 5], previousData: [48, 25, 14, 8, 5] },
                            topTxType: { labels: ['Chuy·ªÉn kho·∫£n', 'Thanh to√°n Hƒê', 'N·∫°p ti·ªÅn ƒêT', 'Qu√©t QR', 'Ti·∫øt ki·ªám'], data: [2.2, 1.1, 0.7, 0.4, 0.4], previousData: [2.0, 1.0, 0.6, 0.3, 0.3] },
                            txByRegion: { labels: ['H·ªì Ch√≠ Minh', 'H√† N·ªôi', 'ƒê√† N·∫µng', 'C·∫ßn Th∆°', 'Kh√°c'], data: [1.8, 1.3, 0.6, 0.5, 0.3], previousData: [1.7, 1.2, 0.6, 0.5, 0.3] },
                            stickiness: { labels: ['T10', 'T11', 'T12'], data: [25, 24, 26], previousData: [24, 23, 25] }
                        },
                        '90': {
                            kpi: {
                                mau: { current: '1.15M', previous: '1.00M', change: '+15.2%', changeColor: 'text-green-600' },
                                newUsers: { current: '140,100', previous: '127,200', change: '+10.1%', changeColor: 'text-green-600' },
                                totalTx: { current: '65.1M', previous: '54.0M', change: '+20.5%', changeColor: 'text-green-600' },
                                successRate: { current: '99.2%', previous: '99.1%', change: '+0.1%', changeColor: 'text-green-600' },
                                txSuccess: { current: '99.2%', previous: '99.1%', change: '+0.1%', changeColor: 'text-green-600' },
                                txRealtime: { current: '98.6%', previous: '98.4%', change: '+0.2%', changeColor: 'text-green-600' },
                                txFail: { current: '0.8%', previous: '0.9%', change: '-0.1%', changeColor: 'text-green-600' },
                                txCoreError: { current: '0.3%', previous: '0.35%', change: '-0.05%', changeColor: 'text-green-600' },
                                newTxCustomers: { current: '58,920', previous: '52,180', change: '+12.9%', changeColor: 'text-green-600' },
                                churn: { current: '4.5%', previous: '4.3%', change: '+0.2%', changeColor: 'text-red-600' },
                                session: { current: '3.3 ph√∫t', previous: '3.2 ph√∫t', change: '+5s', changeColor: 'text-green-600' },
                                totalLogin: { current: '2,654,180', previous: '2,489,750', change: '+6.6%', changeColor: 'text-green-600' }
                            },
                            dau: { labels: Array(90).fill('T').map((v, i) => v + (i+1)), data: Array(90).fill(0).map((_, i) => 200 + i * 3.5 + Math.sin(i / 5) * 20), previousData: Array(90).fill(0).map((_, i) => 180 + i * 3.4 + Math.sin(i / 5) * 15) },
                            txVolume: { labels: Array(90).fill('T').map((v, i) => v + (i+1)), data: Array(90).fill(0).map((_, i) => 0.5 + i * 0.02 + Math.sin(i / 6) * 0.1), previousData: Array(90).fill(0).map((_, i) => 0.4 + i * 0.019 + Math.sin(i / 6) * 0.09) },
                            onboarding: { labels: ['Truy c·∫≠p App', 'B·∫Øt ƒë·∫ßu ƒêK', 'X√°c th·ª±c OTP', 'eKYC', 'Ho√†n th√†nh'], data: [65000, 50000, 48000, 33000, 31000], previousData: [62000, 48000, 46000, 31000, 29000] },
                            acquisition: { labels: ['eskyone', 'S3', 'Partner', 'Counter'], data: [42, 28, 18, 12], previousData: [40, 30, 18, 12] },
                            onboardingByRegion: { labels: ['H·ªì Ch√≠ Minh', 'H√† N·ªôi', 'ƒê√† N·∫µng', 'C·∫ßn Th∆°', 'Kh√°c'], data: [25500, 18600, 9300, 8400, 4800], previousData: [23400, 17100, 8700, 7800, 4200] },
                            onboardingByCampaign: { labels: ['Summer Sale', 'New User Bonus', 'Referral Program', 'Holiday Promo', 'Kh√°c'], data: [12600, 11400, 8700, 6300, 5400], previousData: [11700, 10500, 8100, 5700, 4900] },
                            txSuccessFail: { labels: ['Th√†nh c√¥ng', 'Th·∫•t b·∫°i'], data: [99.2, 0.8], previousData: [99.1, 0.9] },
                            txFailReason: { labels: ['L·ªói Core Bank', 'Timeout h·ªá th·ªëng', 'Sai th√¥ng tin', 'L·ªói k·∫øt n·ªëi', 'H·∫øt h·∫°n GD'], data: [40, 30, 15, 10, 5], previousData: [42, 28, 15, 10, 5] },
                            topTxType: { labels: ['Chuy·ªÉn kho·∫£n', 'Thanh to√°n Hƒê', 'N·∫°p ti·ªÅn ƒêT', 'Qu√©t QR', 'Ti·∫øt ki·ªám'], data: [30.1, 15.2, 9.8, 5.5, 4.5], previousData: [28.0, 14.1, 8.5, 5.0, 4.0] },
                            txByRegion: { labels: ['H·ªì Ch√≠ Minh', 'H√† N·ªôi', 'ƒê√† N·∫µng', 'C·∫ßn Th∆°', 'Kh√°c'], data: [25.5, 18.6, 9.3, 8.4, 4.8], previousData: [23.4, 17.1, 8.7, 7.8, 4.2] },
                            stickiness: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'], data: [15, 16, 17, 18, 19, 20, 19, 21, 22, 23, 22, 24], previousData: [14, 15, 16, 17, 18, 19, 18, 20, 21, 22, 21, 23] }
                        },
                        'all': {
                            kpi: {
                                mau: { current: '1.25M', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                newUsers: { current: '500,000', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                totalTx: { current: '150M', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                successRate: { current: '99.0%', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                txSuccess: { current: '99.0%', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                txRealtime: { current: '98.0%', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                txFail: { current: '1.0%', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                txCoreError: { current: '0.4%', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                newTxCustomers: { current: '285,600', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                churn: { current: '5.0%', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                session: { current: '3.0 ph√∫t', previous: '', change: 'N/A', changeColor: 'text-gray-500' },
                                totalLogin: { current: '12,450,890', previous: '', change: 'N/A', changeColor: 'text-gray-500' }
                            },
                            dau: { labels: Array(365).fill('T').map((v, i) => v + (i+1)), data: Array(365).fill(0).map((_, i) => 100 + i * 1.2 + Math.sin(i / 10) * 30) },
                            txVolume: { labels: Array(365).fill('T').map((v, i) => v + (i+1)), data: Array(365).fill(0).map((_, i) => 0.2 + i * 0.006 + Math.sin(i / 12) * 0.1) },
                            onboarding: { labels: ['Truy c·∫≠p App', 'B·∫Øt ƒë·∫ßu ƒêK', 'X√°c th·ª±c OTP', 'eKYC', 'Ho√†n th√†nh'], data: [250000, 200000, 190000, 140000, 130000] },
                            acquisition: { labels: ['eskyone', 'S3', 'Partner', 'Counter'], data: [50, 20, 20, 10] },
                            onboardingByRegion: { labels: ['H·ªì Ch√≠ Minh', 'H√† N·ªôi', 'ƒê√† N·∫µng', 'C·∫ßn Th∆°', 'Kh√°c'], data: [119500, 87200, 43600, 39200, 22400] },
                            onboardingByCampaign: { labels: ['Summer Sale', 'New User Bonus', 'Referral Program', 'Holiday Promo', 'Kh√°c'], data: [58800, 53200, 40600, 29400, 25200] },
                            txSuccessFail: { labels: ['Th√†nh c√¥ng', 'Th·∫•t b·∫°i'], data: [99.0, 1.0] },
                            txFailReason: { labels: ['L·ªói Core Bank', 'Timeout h·ªá th·ªëng', 'Sai th√¥ng tin', 'L·ªói k·∫øt n·ªëi', 'H·∫øt h·∫°n GD'], data: [42, 28, 15, 10, 5] },
                            topTxType: { labels: ['Chuy·ªÉn kho·∫£n', 'Thanh to√°n Hƒê', 'N·∫°p ti·ªÅn ƒêT', 'Qu√©t QR', 'Ti·∫øt ki·ªám'], data: [70.5, 30.1, 20.2, 15.1, 14.1] },
                            txByRegion: { labels: ['H·ªì Ch√≠ Minh', 'H√† N·ªôi', 'ƒê√† N·∫µng', 'C·∫ßn Th∆°', 'Kh√°c'], data: [119.5, 87.2, 43.6, 39.2, 22.4] },
                            stickiness: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'], data: [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21] }
                        }
                    };

                    let chartInstances = {};

                    const modal = document.getElementById('gemini-modal');
                    const modalClose = document.getElementById('modal-close');
                    const modalTitle = document.getElementById('modal-title');
                    const modalLoader = document.getElementById('modal-loader');
                    const modalResult = document.getElementById('modal-result');

                    function showModal(title) {
                        modalTitle.textContent = title;
                        modalLoader.style.display = 'flex';
                        modalResult.style.display = 'none';
                        modal.style.display = 'flex';
                    }

                    function hideModal() {
                        modal.style.display = 'none';
                    }

                    function setModalResult(content) {
                        modalLoader.style.display = 'none';
                        modalResult.innerHTML = content;
                        modalResult.style.display = 'block';
                    }

                    function setModalError(error) {
                        modalLoader.style.display = 'none';
                        modalResult.innerHTML = `<div class="text-red-600 p-4 bg-red-100 rounded"><b>L·ªói:</b> ${error}</div>`;
                        modalResult.style.display = 'block';
                    }

                    modalClose.addEventListener('click', hideModal);
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) hideModal();
                    });

                    async function callGemini(prompt, retries = 3, delay = 1000) {
                        const apiKey = ""; 
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                        const payload = {
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: {
                                parts: [{ text: "B·∫°n l√† chuy√™n gia ph√¢n t√≠ch d·ªØ li·ªáu m·∫£ng ng√¢n h√†ng s·ªë. H√£y tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, ph√¢n t√≠ch s√¢u, chuy√™n nghi·ªáp, v√† ƒë∆∞a ra c√°c ƒë·ªÅ xu·∫•t h√†nh ƒë·ªông (actionable insights) c·ª• th·ªÉ, ƒë√°nh s·ªë t·ª´ng m·ª•c." }]
                            },
                        };

                        for (let i = 0; i < retries; i++) {
                            try {
                                const response = await fetch(apiUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });

                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }

                                const result = await response.json();
                                const candidate = result.candidates?.[0];

                                if (candidate && candidate.content?.parts?.[0]?.text) {
                                    return candidate.content.parts[0].text;
                                } else {
                                    throw new Error("Ph·∫£n h·ªìi t·ª´ API kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ch·ª©a n·ªôi dung.");
                                }
                            } catch (error) {
                                if (i === retries - 1) {
                                    throw error;
                                }
                                await new Promise(res => setTimeout(res, delay * (i + 1)));
                            }
                        }
                    }

                    const chartOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            datalabels: {
                                display: false,
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 16,
                                    font: {
                                        size: 13
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0,0,0,0.85)',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: true,
                                boxPadding: 4,
                                caretSize: 6,
                                caretPadding: 10,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        let value = context.parsed.y;
                                        if (context.parsed.x !== null && context.chart.options.indexAxis === 'y') {
                                            value = context.parsed.x;
                                        }

                                        if (value !== null) {
                                            if (context.chart.canvas.id.includes('Funnel')) {
                                                label = (context.dataset.label || '') + ': ' + value.toLocaleString('vi-VN') + ' users';
                                            } else if (context.chart.canvas.id.includes('SuccessFail') || context.chart.canvas.id.includes('Acquisition') || context.chart.canvas.id.includes('txFailReason')) {
                                                label = (context.dataset.label || '') + ': ' + value + '%';
                                            } else if (context.chart.canvas.id.includes('stickiness')) {
                                                label = (context.dataset.label || '') + ': ' + value + '%';
                                            } else if (context.chart.canvas.id.includes('topTxType') || context.chart.canvas.id.includes('txVolume')) {
                                                label = (context.dataset.label || '') + ': ' + value + 'M';
                                            } else {
                                                label += value;
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false,
                                    borderColor: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value, index, ticks) {
                                        const label = this.getLabelForValue(value);
                                        if (label.length > 10) {
                                            return label.substring(0, 10) + '...';
                                        }
                                        return label;
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    borderDash: [3, 3]
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        }
                    };
                    
                    function createChart(ctx, type, data, options) {
                        const id = ctx.canvas.id;
                        if (chartInstances[id]) {
                            chartInstances[id].destroy();
                        }
                        chartInstances[id] = new Chart(ctx, { 
                            type, 
                            data, 
                            options: { ...chartOptions, ...options }
                        });
                    }

                    function updateKPIs(data) {
                        // data is chartData[period].kpi
                        for (const [key, values] of Object.entries(data)) {
                            // key = 'mau', 'newUsers', etc.
                            // values = { current: '...', previous: '...', change: '...', changeColor: '...' }

                            const currentEl = document.getElementById(`kpi-${key}-current`);
                            const changeEl = document.getElementById(`kpi-${key}-change`);
                            const previousEl = document.getElementById(`kpi-${key}-previous`);

                            if (currentEl) currentEl.textContent = values.current;
                            if (changeEl) {
                                changeEl.textContent = values.change;
                                changeEl.className = `kpi-change ${values.changeColor}`;
                            }
                            if (previousEl) {
                                if (values.previous) {
                                    previousEl.textContent = `vs ${values.previous}`;
                                } else {
                                    previousEl.textContent = ''; // Clear it if no previous value (e.g., 'all' time)
                                }
                            }
                        }
                    }

                    function initOverviewCharts(data) {
                        const dauCtx = document.getElementById('dauChart');
                        if (dauCtx) {
                            const datasets = [{
                                label: 'DAU (K·ª≥ n√†y)',
                                data: data.dau.data,
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.1,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#4f46e5',
                                pointBorderColor: '#fff',
                                pointHoverBorderColor: '#fff',
                                pointHoverBackgroundColor: '#3730a3'
                            }];

                            if (data.dau.previousData) {
                                datasets.push({
                                    label: 'DAU (K·ª≥ tr∆∞·ªõc)',
                                    data: data.dau.previousData,
                                    borderColor: '#a5b4fc', // Lighter indigo
                                    backgroundColor: 'transparent',
                                    fill: false,
                                    tension: 0.1,
                                    pointRadius: 2,
                                    pointHoverRadius: 4,
                                    borderDash: [5, 5], // Dashed line
                                    pointBackgroundColor: '#a5b4fc',
                                    pointBorderColor: '#fff',
                                    pointHoverBorderColor: '#fff',
                                    pointHoverBackgroundColor: '#818cf8'
                                });
                            }

                            createChart(dauCtx.getContext('2d'), 'line', {
                                labels: data.dau.labels,
                                datasets: datasets
                            }, {});
                        }

                        const txVolumeCtx = document.getElementById('txVolumeChart');
                        if (txVolumeCtx) {
                            const datasets = [{
                                label: 'SL Giao d·ªãch (K·ª≥ n√†y)',
                                data: data.txVolume.data,
                                backgroundColor: '#4f46e5',
                                borderRadius: 6,
                                maxBarThickness: 50
                            }];

                            if (data.txVolume.previousData) {
                                datasets.push({
                                    label: 'SL Giao d·ªãch (K·ª≥ tr∆∞·ªõc)',
                                    data: data.txVolume.previousData,
                                    backgroundColor: '#a5b4fc', // Lighter indigo
                                    borderRadius: 6,
                                    maxBarThickness: 50
                                });
                            }
                            
                            createChart(txVolumeCtx.getContext('2d'), 'bar', {
                                labels: data.txVolume.labels,
                                datasets: datasets
                            }, {
                                plugins: {
                                    datalabels: {
                                        display: (data.dau.labels.length < 31), // Ch·ªâ hi·ªÉn th·ªã n·∫øu √≠t d·ªØ li·ªáu
                                        anchor: 'end',
                                        align: 'top',
                                        color: '#6b7280',
                                        font: {
                                            weight: 'bold',
                                            size: 10
                                        },
                                        formatter: (value) => value + 'M'
                                    }
                                }
                            });
                        }
                    }

                    function initOnboardingCharts(data) {
                        const funnelCtx = document.getElementById('onboardingFunnelChart');
                        if (funnelCtx) {
                            const datasets = [{
                                label: 'S·ªë l∆∞·ª£ng (K·ª≥ n√†y)',
                                data: data.onboarding.data,
                                backgroundColor: '#4f46e5',
                                borderRadius: 6,
                                maxBarThickness: 70
                            }];

                            if (data.onboarding.previousData) {
                                datasets.push({
                                    label: 'S·ªë l∆∞·ª£ng (K·ª≥ tr∆∞·ªõc)',
                                    data: data.onboarding.previousData,
                                    backgroundColor: '#a5b4fc',
                                    borderRadius: 6,
                                    maxBarThickness: 70
                                });
                            }
                            
                            createChart(funnelCtx.getContext('2d'), 'bar', {
                                labels: data.onboarding.labels,
                                datasets: datasets
                            }, { 
                                plugins: { 
                                    datalabels: {
                                        display: true,
                                        anchor: 'end',
                                        align: 'top',
                                        color: '#6b7280',
                                        font: {
                                            weight: 'bold',
                                            size: 11
                                        },
                                        formatter: (value) => value.toLocaleString('vi-VN')
                                    }
                                },
                                scales: { x: { ticks: { callback: function(val) { return wrapLabel(this.getLabelForValue(val), 16); } }}}
                            });
                        }

                        const acquisitionCtx = document.getElementById('acquisitionChannelChart');
                        if (acquisitionCtx) {
                            const datasets = [{
                                label: 'T·ª∑ l·ªá (K·ª≥ n√†y)',
                                data: data.acquisition.data,
                                backgroundColor: '#4f46e5',
                                borderRadius: 6,
                                maxBarThickness: 70
                            }];

                            if (data.acquisition.previousData) {
                                datasets.push({
                                    label: 'T·ª∑ l·ªá (K·ª≥ tr∆∞·ªõc)',
                                    data: data.acquisition.previousData,
                                    backgroundColor: '#a5b4fc',
                                    borderRadius: 6,
                                    maxBarThickness: 70
                                });
                            }
                            
                            createChart(acquisitionCtx.getContext('2d'), 'bar', {
                                labels: data.acquisition.labels,
                                datasets: datasets
                            }, { 
                                plugins: { 
                                    tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}%` }},
                                    datalabels: {
                                        display: true,
                                        anchor: 'end',
                                        align: 'top',
                                        color: '#6b7280',
                                        font: {
                                            weight: 'bold',
                                            size: 11
                                        },
                                        formatter: (value) => value + '%'
                                    }
                                },
                                scales: { y: { ticks: { callback: (val) => val + '%' } } }
                            });
                        }

                        const onboardingRegionCtx = document.getElementById('onboardingByRegionChart');
                        if (onboardingRegionCtx) {
                            const datasets = [{
                                label: 'S·ªë l∆∞·ª£ng (K·ª≥ n√†y)',
                                data: data.onboardingByRegion.data,
                                backgroundColor: '#7c3aed',
                                borderRadius: 6,
                                maxBarThickness: 70
                            }];

                            if (data.onboardingByRegion.previousData) {
                                datasets.push({
                                    label: 'S·ªë l∆∞·ª£ng (K·ª≥ tr∆∞·ªõc)',
                                    data: data.onboardingByRegion.previousData,
                                    backgroundColor: '#a78bfa',
                                    borderRadius: 6,
                                    maxBarThickness: 70
                                });
                            }
                            
                            createChart(onboardingRegionCtx.getContext('2d'), 'bar', {
                                labels: data.onboardingByRegion.labels,
                                datasets: datasets
                            }, { 
                                plugins: { 
                                    datalabels: {
                                        display: true,
                                        anchor: 'end',
                                        align: 'top',
                                        color: '#6b7280',
                                        font: {
                                            weight: 'bold',
                                            size: 11
                                        },
                                        formatter: (value) => value.toLocaleString('vi-VN')
                                    }
                                },
                                scales: { x: { ticks: { callback: function(val) { return wrapLabel(this.getLabelForValue(val), 16); } }}}
                            });
                        }

                        const onboardingCampaignCtx = document.getElementById('onboardingByCampaignChart');
                        if (onboardingCampaignCtx) {
                            const datasets = [{
                                label: 'S·ªë l∆∞·ª£ng (K·ª≥ n√†y)',
                                data: data.onboardingByCampaign.data,
                                backgroundColor: '#dc2626',
                                borderRadius: 6,
                                maxBarThickness: 70
                            }];

                            if (data.onboardingByCampaign.previousData) {
                                datasets.push({
                                    label: 'S·ªë l∆∞·ª£ng (K·ª≥ tr∆∞·ªõc)',
                                    data: data.onboardingByCampaign.previousData,
                                    backgroundColor: '#f87171',
                                    borderRadius: 6,
                                    maxBarThickness: 70
                                });
                            }
                            
                            createChart(onboardingCampaignCtx.getContext('2d'), 'bar', {
                                labels: data.onboardingByCampaign.labels,
                                datasets: datasets
                            }, { 
                                plugins: { 
                                    datalabels: {
                                        display: true,
                                        anchor: 'end',
                                        align: 'top',
                                        color: '#6b7280',
                                        font: {
                                            weight: 'bold',
                                            size: 11
                                        },
                                        formatter: (value) => value.toLocaleString('vi-VN')
                                    }
                                },
                                scales: { x: { ticks: { callback: function(val) { return wrapLabel(this.getLabelForValue(val), 16); } }}}
                            });
                        }
                    }

                    function initTransactionCharts(data) {
                        const successCtx = document.getElementById('txSuccessFailChart');
                        if (successCtx) {
                            const datasets = [{
                                label: 'T·ª∑ l·ªá (K·ª≥ n√†y)',
                                data: data.txSuccessFail.data,
                                backgroundColor: ['#4f46e5', '#e11d48'],
                                borderRadius: 6,
                                maxBarThickness: 70
                            }];

                            if (data.txSuccessFail.previousData) {
                                datasets.push({
                                    label: 'T·ª∑ l·ªá (K·ª≥ tr∆∞·ªõc)',
                                    data: data.txSuccessFail.previousData,
                                    backgroundColor: ['#a5b4fc', '#f87171'],
                                    borderRadius: 6,
                                    maxBarThickness: 70
                                });
                            }
                            
                            createChart(successCtx.getContext('2d'), 'bar', {
                                labels: data.txSuccessFail.labels,
                                datasets: datasets
                            }, { 
                                plugins: { 
                                    tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}%` }},
                                    datalabels: {
                                        display: true,
                                        anchor: 'end',
                                        align: 'top',
                                        color: '#6b7280',
                                        font: {
                                            weight: 'bold',
                                            size: 11
                                        },
                                        formatter: (value) => value + '%'
                                    }
                                },
                                scales: { y: { ticks: { callback: (val) => val + '%' } } }
                            });
                        }

                        const failCtx = document.getElementById('txFailReasonChart');
                        if (failCtx) {
                            const datasets = [{
                                label: 'T·ª∑ l·ªá (K·ª≥ n√†y)',
                                data: data.txFailReason.data,
                                backgroundColor: '#e11d48',
                                borderRadius: 6,
                                maxBarThickness: 50
                            }];
                            
                            if (data.txFailReason.previousData) {
                                datasets.push({
                                    label: 'T·ª∑ l·ªá (K·ª≥ tr∆∞·ªõc)',
                                    data: data.txFailReason.previousData,
                                    backgroundColor: '#f87171',
                                    borderRadius: 6,
                                    maxBarThickness: 50
                                });
                            }
                            
                            createChart(failCtx.getContext('2d'), 'bar', {
                                labels: data.txFailReason.labels,
                                datasets: datasets
                            }, { 
                                indexAxis: 'y', 
                                plugins: { 
                                    datalabels: {
                                        display: true,
                                        anchor: 'end',
                                        align: 'end',
                                        padding: { left: 4 },
                                        color: '#374151',
                                        font: {
                                            weight: 'bold',
                                            size: 11
                                        },
                                        formatter: (value) => value + '%'
                                    }
                                },
                                scales: { y: { ticks: { font: { size: 10 } } }, x: { ticks: { callback: (val) => val + '%' } } }
                            });
                        }

                        const topTxCtx = document.getElementById('topTxTypeChart');
                        if (topTxCtx) {
                            const datasets = [{
                                label: 'SL Giao d·ªãch (K·ª≥ n√†y)',
                                data: data.topTxType.data,
                                backgroundColor: '#3730a3',
                                borderRadius: 6,
                                maxBarThickness: 50
                            }];

                            if (data.topTxType.previousData) {
                                datasets.push({
                                    label: 'SL Giao d·ªãch (K·ª≥ tr∆∞·ªõc)',
                                    data: data.topTxType.previousData,
                                    backgroundColor: '#818cf8',
                                    borderRadius: 6,
                                    maxBarThickness: 50
                                });
                            }
                            
                            createChart(topTxCtx.getContext('2d'), 'bar', {
                                labels: data.topTxType.labels,
                                datasets: datasets
                            }, { 
                                plugins: { 
                                    datalabels: {
                                        display: true,
                                        anchor: 'end',
                                        align: 'top',
                                        color: '#6b7280',
                                        font: {
                                            weight: 'bold',
                                            size: 11
                                        },
                                        formatter: (value) => value + 'M'
                                    }
                                },
                                scales: { x: { ticks: { callback: function(val) { return wrapLabel(this.getLabelForValue(val), 16); } }}}
                            });
                        }

                        const txRegionCtx = document.getElementById('txByRegionChart');
                        if (txRegionCtx) {
                            const datasets = [{
                                label: 'SL Giao d·ªãch (K·ª≥ n√†y)',
                                data: data.txByRegion.data,
                                backgroundColor: '#059669',
                                borderRadius: 6,
                                maxBarThickness: 50
                            }];

                            if (data.txByRegion.previousData) {
                                datasets.push({
                                    label: 'SL Giao d·ªãch (K·ª≥ tr∆∞·ªõc)',
                                    data: data.txByRegion.previousData,
                                    backgroundColor: '#10b981',
                                    borderRadius: 6,
                                    maxBarThickness: 50
                                });
                            }
                            
                            createChart(txRegionCtx.getContext('2d'), 'bar', {
                                labels: data.txByRegion.labels,
                                datasets: datasets
                            }, { 
                                plugins: { 
                                    datalabels: {
                                        display: true,
                                        anchor: 'end',
                                        align: 'top',
                                        color: '#6b7280',
                                        font: {
                                            weight: 'bold',
                                            size: 11
                                        },
                                        formatter: (value) => value + 'M'
                                    }
                                },
                                scales: { x: { ticks: { callback: function(val) { return wrapLabel(this.getLabelForValue(val), 16); } }}}
                            });
                        }
                    }

                    function initEngagementCharts(data) {
                        const stickinessCtx = document.getElementById('stickinessChart');
                        if (stickinessCtx) {
                            const datasets = [{
                                label: 'T·ª∑ l·ªá (K·ª≥ n√†y)',
                                data: data.stickiness.data,
                                borderColor: '#f7b731',
                                backgroundColor: 'rgba(247, 183, 49, 0.1)',
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#f7b731',
                                pointBorderColor: '#fff',
                                pointHoverBorderColor: '#fff',
                                pointHoverBackgroundColor: '#d99a0b'
                            }];
                            
                            if (data.stickiness.previousData) {
                                datasets.push({
                                    label: 'T·ª∑ l·ªá (K·ª≥ tr∆∞·ªõc)',
                                    data: data.stickiness.previousData,
                                    borderColor: '#fbbf24', // Lighter yellow
                                    backgroundColor: 'transparent',
                                    fill: false,
                                    tension: 0.1,
                                    pointRadius: 2,
                                    pointHoverRadius: 4,
                                    borderDash: [5, 5], // Dashed line
                                    pointBackgroundColor: '#fbbf24',
                                    pointBorderColor: '#fff',
                                    pointHoverBorderColor: '#fff',
                                    pointHoverBackgroundColor: '#f59e0b'
                                });
                            }
                            
                            createChart(stickinessCtx.getContext('2d'), 'line', {
                                labels: data.stickiness.labels,
                                datasets: datasets
                            }, { 
                                scales: { y: { ticks: { callback: (val) => val + '%' } } }
                            });
                        }
                    }
                    
                    function wrapLabel(label, maxWidth) {
                        if (label.length <= maxWidth) return label;
                        let parts = label.split(' ');
                        let lines = [];
                        let currentLine = '';
                        parts.forEach(part => {
                            if ((currentLine + part).length > maxWidth) {
                                lines.push(currentLine.trim());
                                currentLine = part + ' ';
                            } else {
                                currentLine += part + ' ';
                            }
                        });
                        lines.push(currentLine.trim());
                        return lines;
                    }

                    function updateDashboard(period) {
                        const data = chartData[period];
                        if (!data) return;

                        // H·ªßy t·∫•t c·∫£ chart c≈©
                        for (const id in chartInstances) {
                            if (chartInstances[id]) {
                                chartInstances[id].destroy();
                            }
                        }
                        chartInstances = {};

                        // C·∫≠p nh·∫≠t KPIs
                        updateKPIs(data.kpi);

                        // V·∫Ω l·∫°i t·∫•t c·∫£ charts
                        initOverviewCharts(data);
                        initOnboardingCharts(data);
                        initTransactionCharts(data);
                        initEngagementCharts(data);
                    }

                    document.getElementById('date-filter').addEventListener('change', (e) => {
                        updateDashboard(e.target.value);
                    });

                    // Initial load
                    updateDashboard('30');

                    // Gemini button listeners
                    const analyzeOnboardingBtn = document.getElementById('analyze-onboarding');
                    const analyzeFailuresBtn = document.getElementById('analyze-failures');
                    const analyzeEngagementBtn = document.getElementById('analyze-engagement');

                    analyzeOnboardingBtn.addEventListener('click', async () => {
                        try {
                            showModal('‚ú® ƒêang ph√¢n t√≠ch ph·ªÖu...');
                            const period = document.getElementById('date-filter').value;
                            const data = chartData[period].onboarding;
                            const prompt = `Ph√¢n t√≠ch ph·ªÖu onboarding sau:\nK·ª≥ n√†y:\n${data.labels.map((l, i) => `${l}: ${data.data[i]}`).join('\n')}\nK·ª≥ tr∆∞·ªõc:\n${data.labels.map((l, i) => `${l}: ${data.previousData ? data.previousData[i] : 'N/A'}`).join('\n')}\nSo s√°nh 2 k·ª≥, ƒë·∫∑c bi·ªát ch√∫ √Ω ƒë·∫øn ƒëi·ªÉm r∆°i l·ªõn nh·∫•t v√† s·ª± thay ƒë·ªïi. ƒê∆∞a ra 3 ƒë·ªÅ xu·∫•t c·ª• th·ªÉ ƒë·ªÉ c·∫£i thi·ªán.`;
                            const result = await callGemini(prompt);
                            setModalResult(result);
                        } catch (error) {
                            setModalError(`L·ªói ph√¢n t√≠ch: ${error.message}`);
                        }
                    });

                    analyzeFailuresBtn.addEventListener('click', async () => {
                        try {
                            showModal('‚ú® ƒêang ph√¢n t√≠ch l·ªói giao d·ªãch...');
                            const period = document.getElementById('date-filter').value;
                            const data = chartData[period].txFailReason;
                            const prompt = `Ph√¢n t√≠ch c√°c l√Ω do giao d·ªãch th·∫•t b·∫°i (t√≠nh theo %):\nK·ª≥ n√†y:\n${data.labels.map((l, i) => `${l}: ${data.data[i]}%`).join('\n')}\nK·ª≥ tr∆∞·ªõc:\n${data.labels.map((l, i) => `${l}: ${data.previousData ? data.previousData[i] : 'N/A'}%`).join('\n')}\nNguy√™n nh√¢n n√†o l√† nghi√™m tr·ªçng nh·∫•t v√† c√≥ xu h∆∞·ªõng tƒÉng? ƒê∆∞a ra 3 ƒë·ªÅ xu·∫•t c·ª• th·ªÉ (bao g·ªìm c·∫£ k·ªπ thu·∫≠t v√† nghi·ªáp v·ª•) ƒë·ªÉ gi·∫£m t·ª∑ l·ªá l·ªói n√†y.`;
                            const result = await callGemini(prompt);
                            setModalResult(result);
                        } catch (error) {
                            setModalError(`L·ªói ph√¢n t√≠ch: ${error.message}`);
                        }
                    });

                    analyzeEngagementBtn.addEventListener('click', async () => {
                        try {
                            showModal('‚ú® ƒêang t√¨m g·ª£i √Ω c·∫£i thi·ªán...');
                            const period = document.getElementById('date-filter').value;
                            const data = chartData[period].stickiness;
                            const kpiData = chartData[period].kpi;
                            const prompt = `Ph√¢n t√≠ch c√°c ch·ªâ s·ªë t∆∞∆°ng t√°c:\n- T·ª∑ l·ªá DAU/MAU (K·ª≥ n√†y): ${data.data.join(', ')}%\n- T·ª∑ l·ªá DAU/MAU (K·ª≥ tr∆∞·ªõc): ${data.previousData ? data.previousData.join(', ') : 'N/A'}%\n- Churn Rate: ${kpiData.churn.current} (vs ${kpiData.churn.previous})\n- Avg Session Length: ${kpiData.session.current} (vs ${kpiData.session.previous})\nXu h∆∞·ªõng chung l√† g√¨ v√† ƒë·ªÅ xu·∫•t 3 chi·∫øn l∆∞·ª£c c·ª• th·ªÉ ƒë·ªÉ tƒÉng 'stickiness' v√† gi·∫£m 'churn'.`;
                            const result = await callGemini(prompt);
                            setModalResult(result);
                        } catch (error) {
                            setModalError(`L·ªói ph√¢n t√≠ch: ${error.message}`);
                        }
                    });

                    // Tab switching functionality
                    window.switchTab = function(tabName) {
                        // Hide all tab contents
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        // Show selected tab content
                        document.getElementById('content-' + tabName).classList.add('active');
                        
                        // Update tab button states
                        document.querySelectorAll('.tab-button').forEach(button => {
                            button.classList.remove('active');
                            button.classList.add('inactive');
                        });
                        
                        // Activate selected tab button
                        document.getElementById('tab-' + tabName).classList.remove('inactive');
                        document.getElementById('tab-' + tabName).classList.add('active');
                        
                        // Redraw charts for the active tab
                        const period = document.getElementById('date-filter').value;
                        const data = chartData[period];
                        if (!data) return;

                        // Small delay to ensure DOM is updated
                        setTimeout(() => {
                            if (tabName === 'overview') {
                                initOverviewCharts(data);
                            } else if (tabName === 'onboarding') {
                                initOnboardingCharts(data);
                            } else if (tabName === 'transaction') {
                                initTransactionCharts(data);
                            } else if (tabName === 'engagement') {
                                initEngagementCharts(data);
                            }
                        }, 100);
                    };

                    // Update KPI function to handle tab-specific KPIs
                    function updateTabKPIs(data) {
                        // Update overview KPIs
                        updateKPIs(data);
                        
                        // Update onboarding KPIs
                        const onbElements = {
                            'kpi-onb-newUsers-current': data.newUsers.current,
                            'kpi-onb-newUsers-change': data.newUsers.change,
                            'kpi-onb-newUsers-previous': data.newUsers.previous ? `vs ${data.newUsers.previous}` : '',
                            'kpi-onb-conversion-current': '67.9%',
                            'kpi-onb-conversion-change': '+2.1%',
                            'kpi-onb-conversion-previous': 'vs 65.8%'
                        };
                        
                        // Update transaction KPIs  
                        const txElements = {
                            'kpi-tx-txSuccess-current': data.txSuccess.current,
                            'kpi-tx-txSuccess-change': data.txSuccess.change,
                            'kpi-tx-txSuccess-previous': data.txSuccess.previous ? `vs ${data.txSuccess.previous}` : '',
                            'kpi-tx-txRealtime-current': data.txRealtime.current,
                            'kpi-tx-txRealtime-change': data.txRealtime.change,
                            'kpi-tx-txRealtime-previous': data.txRealtime.previous ? `vs ${data.txRealtime.previous}` : '',
                            'kpi-tx-txFail-current': data.txFail.current,
                            'kpi-tx-txFail-change': data.txFail.change,
                            'kpi-tx-txFail-previous': data.txFail.previous ? `vs ${data.txFail.previous}` : '',
                            'kpi-tx-txCoreError-current': data.txCoreError.current,
                            'kpi-tx-txCoreError-change': data.txCoreError.change,
                            'kpi-tx-txCoreError-previous': data.txCoreError.previous ? `vs ${data.txCoreError.previous}` : '',
                            'kpi-tx-newTxCustomers-current': data.newTxCustomers.current,
                            'kpi-tx-newTxCustomers-change': data.newTxCustomers.change,
                            'kpi-tx-newTxCustomers-previous': data.newTxCustomers.previous ? `vs ${data.newTxCustomers.previous}` : ''
                        };
                        
                        // Update engagement KPIs
                        const engElements = {
                            'kpi-eng-churn-current': data.churn.current,
                            'kpi-eng-churn-change': data.churn.change,
                            'kpi-eng-churn-previous': data.churn.previous ? `vs ${data.churn.previous}` : '',
                            'kpi-eng-session-current': data.session.current,
                            'kpi-eng-session-change': data.session.change,
                            'kpi-eng-session-previous': data.session.previous ? `vs ${data.session.previous}` : '',
                            'kpi-eng-totalLogin-current': data.totalLogin.current,
                            'kpi-eng-totalLogin-change': data.totalLogin.change,
                            'kpi-eng-totalLogin-previous': data.totalLogin.previous ? `vs ${data.totalLogin.previous}` : ''
                        };

                        // Apply all updates
                        [...Object.entries(onbElements), ...Object.entries(txElements), ...Object.entries(engElements)].forEach(([id, value]) => {
                            const el = document.getElementById(id);
                            if (el) {
                                if (id.includes('-change')) {
                                    // Handle change color classes
                                    const changeColor = data[id.split('-')[2]]?.changeColor || 'text-gray-500';
                                    el.className = `kpi-change ${changeColor}`;
                                    el.textContent = value;
                                } else {
                                    el.textContent = value;
                                }
                            }
                        });
                    }

                    // Override the updateDashboard function to include tab KPIs
                    function updateDashboard(period) {
                        const data = chartData[period];
                        if (!data) return;

                        // H·ªßy t·∫•t c·∫£ chart c≈©
                        for (const id in chartInstances) {
                            if (chartInstances[id]) {
                                chartInstances[id].destroy();
                            }
                        }
                        chartInstances = {};

                        // C·∫≠p nh·∫≠t t·∫•t c·∫£ KPIs
                        updateTabKPIs(data.kpi);

                        // V·∫Ω l·∫°i charts cho tab ƒëang active
                        const activeTab = document.querySelector('.tab-content.active').id.replace('content-', '');
                        if (activeTab === 'overview') {
                            initOverviewCharts(data);
                        } else if (activeTab === 'onboarding') {
                            initOnboardingCharts(data);
                        } else if (activeTab === 'transaction') {
                            initTransactionCharts(data);
                        } else if (activeTab === 'engagement') {
                            initEngagementCharts(data);
                        }
                    }

                });
            </script>
        </body>
        </html>

